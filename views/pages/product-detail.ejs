<section class="product-detail container">
  <nav class="pd-breadcrumb" style="margin-top: 2rem;">
    <a href="/homepage">Home</a> <span>/</span>
    <a href="/products/all">Products</a> <span>/</span>
    <span class="current"><%= product?.name %></span>
  </nav>

  <div class="pd-wrap">
    <div class="pd-gallery">
      <% 
        let imgs = (product?.images?.length ? product.images : ['https://placehold.co/800x600?text=No+Image']);
        
        // === FIX LỖI: Thêm dấu / cho tất cả ảnh nội bộ ===
        imgs = imgs.map(img => {
            if (img && !img.startsWith('http') && !img.startsWith('/')) {
                return '/' + img;
            }
            return img;
        });
      %>
      <div class="pd-main">
        <img id="pdMainImg" src="<%= imgs[0] %>" alt="<%= product?.name %>">

        <button id="pdSlidePrev" class="pd-slide-btn prev" aria-label="Previous image">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <button id="pdSlideNext" class="pd-slide-btn next" aria-label="Next image">
          <i class="fa-solid fa-chevron-right"></i>
        </button>
      </div>
      <% if (imgs.length > 1) { %>
      <div class="pd-thumbs">
        <% imgs.forEach((src, i) => { %>
        <img class="pd-thumb-item <%= i===0 ? 'active' : '' %>" src="<%= src %>" alt="thumb <%= i+1 %>">
        <% }) %>
      </div>
      <% } %>
    </div>

    <div class="pd-info">
      <% if (product?.brandId?.name) { %>
      <span class="pd-brand"><%= product.brandId.name %></span>
      <% } %>

      <h1 class="pd-title"><%= product?.name %></h1>

      <div class="pd-rating">
        <% if (product?.ratingAvg) { %>
        <span class="stars">★ <%= Number(product.ratingAvg).toFixed(1) %></span>
        <% if (product?.ratingCount) { %>
        <span class="rating-info">(<%= product.ratingCount %> đánh giá)</span>
        <% } %>
        <% } else { %>
        <span class="rating-info">Chưa có đánh giá</span>
        <% } %>
      </div>

      <div class="pd-meta-row" style="margin-top: 8px;">
        <span class="sku">SKU: <span id="pdSku"><%= (product?.variants && product.variants[0]?.sku) || 'N/A' %></span></span>
      </div>


      <div class="pd-price-section">
        <div class="pd-price-wrap">
          <span class="pd-price" id="pdPrice">
            <%= ((product?.variants && product.variants[0]?.price) || product?.basePrice || 0).toLocaleString('vi-VN') %>đ
          </span>
        </div>
        <span class="pd-tax-info">Đã bao gồm VAT</span>
      </div>

      <% if (product?.shortDesc) { %>
      <p class="pd-short-desc" style="min-height: 8em;">
        <%= product.shortDesc %><br>
      </p>
      <% } %>

      <% if (product?.variants?.length) { 
           const colors = [...new Set(product.variants.map(v => v.color).filter(Boolean))];
           const sizes  = [...new Set(product.variants.map(v => v.size).filter(Boolean))];
           
           // Truyền dữ liệu variants cho JS qua data-attribute
           const variantsJson = JSON.stringify(product.variants.map(v => ({
             sku: v.sku,
             color: v.color,
             size: v.size,
             price: v.price,
             stock: v.stock,
             images: v.images || []
           })));
      %>
      <div class="pd-variants" data-variants="<%= variantsJson %>" data-product-id="<%= product._id %>">
        <% if (colors.length) { %>
        <div class="variant-group" id="group-color">
          <label class="variant-label">Màu sắc: <strong id="selectedColorText"></strong></label>
          <div class="variant-list">
            <% colors.forEach(c => { %>
            <button class="variant-chip" type="button" data-variant-type="color" data-value="<%= c %>">
              <%= c %>
            </button>
            <% }) %>
          </div>
        </div>
        <% } %>
        <% if (sizes.length) { %>
        <div class="variant-group" id="group-size">
          <label class="variant-label">Size: <strong id="selectedSizeText"></strong></label>
          <div class="variant-list">
            <% sizes.forEach(s => { %>
            <button class="variant-chip" type="button" data-variant-type="size" data-value="<%= s %>">
              <%= s %>
            </button>
            <% }) %>
          </div>
        </div>
        <% } %>
      </div>
      <% } %>

      <div class="pd-actions">
        <button class="btn-add-cart" id="btnAddToCart" data-product-id="<%= product._id %>" disabled>
          <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ hàng
        </button>
      </div>
    </div>
  </div> 

<div class="pd-full-details">
    
    <section id="details-description" class="detail-section">
      <h3>Mô Tả Chi Tiết</h3>
      <div class="pd-description">
        <p><%= product?.longDesc || product?.shortDesc || 'Chưa có mô tả chi tiết.' %></p>
        </div>
    </section>

    <section id="details-reviews" class="detail-section">
      <h3>Đánh Giá Sản Phẩm</h3>
      
      <div class="review-layout">
        <div class="review-form-wrapper">
          <% if (isAuthenticated) { %>
            <form id="rating-form" class="review-form-box" data-ajax>
              <h4>Viết đánh giá của bạn</h4>
              <div id="rating-alert" class="alert" style="display:none;"></div>
              <div class="mb-3">
                <label>1. Chọn số sao (*):</label>
                <div class="star-rating-input">
                  <input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label>
                  <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                  <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                  <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                  <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                </div>
              </div>
              <div class="mb-3">
                <label for="rating-comment">2. Viết bình luận (Tùy chọn):</label>
                <textarea id="rating-comment" class="form-control" rows="3"></textarea>
              </div>
              <button type="submit" id="btn-submit-rating" class="btn">Gửi đánh giá</button>
            </form>
          <% } else { %>
            <form id="comment-form" class="review-form-box" data-ajax>
              <h4>Gửi bình luận của bạn</h4>
              <div id="comment-alert" class="alert" style="display:none;"></div>
              <div class="mb-3">
                <label for="comment-name">Tên của bạn (*):</label>
                <input type="text" id="comment-name" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="comment-text">Bình luận (*):</label>
                <textarea id="comment-text" class="form-control" rows="3" required></textarea>
              </div>
              <button type="submit" id="btn-submit-comment" class="btn">Gửi bình luận</button>
              <div class="alert alert-info mt-3">
                Bạn phải <a href="/signin?redirect=/products/<%= product.slug %>">đăng nhập</a> để có thể chấm sao (rating).
              </div>
            </form>
          <% } %>
        </div>

        <div class="review-list-container">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 id="review-list-title" class="mb-0">
      Tất cả đánh giá (<span id="review-total-count"><%= product.ratingCount || 0 %></span>)
    </h4>
    <div class="form-group" style="min-width: 180px;">
      <label for="review-sort-select" class="form-label" style="font-size: 1.3rem; margin-bottom: 2px;">Sắp xếp theo:</label>
      <select class="form-control" id="review-sort-select" style="padding: 5px 8px; font-size: 1.4rem; height: auto;">
        <option value="newest">Mới nhất</option>
        <option value="oldest">Cũ nhất</option>
        <option value="highest">Nhiều sao nhất</option>
        <option value="lowest">Ít sao nhất</option>
      </select>
    </div>
  </div>
  <div id="review-list">
    </div>
  <nav id="review-pagination-container" class="pagination-wrap mt-4" style="border: none; padding: 0;"></nav>
</div>
      </div>
    </section>
  </div>
  <% if (related?.length) { %>
  <div class="related">
    <h3 class="mb-3">Sản phẩm liên quan</h3>
    <div class="product-grid">
      <% related.forEach(r => {
           const img = (r.images && r.images[0]) || 'https://placehold.co/600x600?text=No+Image';
           const price = (r.basePrice || 0).toLocaleString('vi-VN') + 'đ';
      %>
      <article class="product-card">
        <a href="/products/<%= r.slug %>" class="thumb">
          <img src="<%= img %>" alt="<%= r.name %>">
        </a>
        <div class="info">
          <a class="name" href="/products/<%= r.slug %>"><%= r.name %></a>
          <div class="meta"><span class="price"><%= price %></span></div>
        </div>
      </article>
      <% }) %>
    </div>
  </div>
  <% } %>
</section>

<script src="/socket.io/socket.io.js"></script>
<script src="/javascripts/product-detail.js" defer></script>
<script src="/javascripts/product-review.js" defer></script>